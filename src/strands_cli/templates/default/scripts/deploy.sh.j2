#!/bin/bash
set -e

# Deploy {{ name }} to Amazon EKS
#
# Usage:
#   ./scripts/deploy.sh [--environment env] [--namespace ns]
#
# Options:
#   --environment: Environment to deploy to (dev, prod) (default: dev)
#   --namespace: Kubernetes namespace to deploy to (default: default)

# Parse arguments
ENVIRONMENT="dev"
NAMESPACE="default"

while [[ $# -gt 0 ]]; do
  key="$1"
  case $key in
    --environment)
      ENVIRONMENT="$2"
      shift 2
      ;;
    --namespace)
      NAMESPACE="$2"
      shift 2
      ;;
    *)
      echo "Unknown option: $1"
      echo "Usage: ./scripts/deploy.sh [--environment env] [--namespace ns]"
      exit 1
      ;;
  esac
done

# Validate environment
if [[ "${ENVIRONMENT}" != "dev" && "${ENVIRONMENT}" != "prod" ]]; then
  echo "Invalid environment: ${ENVIRONMENT}"
  echo "Valid values: dev, prod"
  exit 1
fi

VALUES_FILE="deployment/helm/values-${ENVIRONMENT}.yaml"
if [[ ! -f "${VALUES_FILE}" ]]; then
  echo "Values file not found: ${VALUES_FILE}"
  exit 1
fi

# Check if helm is installed
if ! command -v helm &> /dev/null; then
  echo "Error: helm is not installed or not in the PATH"
  exit 1
fi

# Check if kubectl is installed
if ! command -v kubectl &> /dev/null; then
  echo "Error: kubectl is not installed or not in the PATH"
  exit 1
fi

# Check kubectl context
CURRENT_CONTEXT=$(kubectl config current-context)
echo "Current kubectl context: ${CURRENT_CONTEXT}"
read -p "Continue with this context? (y/n): " CONFIRM
if [[ "${CONFIRM}" != "y" && "${CONFIRM}" != "Y" ]]; then
  echo "Deployment cancelled"
  exit 0
fi

# Deploy using Helm
echo "Deploying {{ name }} to namespace ${NAMESPACE} in environment ${ENVIRONMENT}..."
helm upgrade --install {{ name }} deployment/helm \
  --namespace ${NAMESPACE} \
  --create-namespace \
  --values ${VALUES_FILE}

echo "Deployment completed successfully!"
echo ""
echo "To check the status:"
echo "  kubectl get pods -n ${NAMESPACE}"
echo ""
echo "To get the service URL (if ingress is enabled):"
echo "  kubectl get ingress -n ${NAMESPACE}"